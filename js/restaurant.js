"use strict";var _createClass=function(){function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}}();function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var newMap,DBHelper=function(){function i(){_classCallCheck(this,i)}return _createClass(i,null,[{key:"openIndexedDB",value:function(n){if(!navigator.serviceWorker||!window.indexedDB)return console.log("IndexedDB not supported");var t,e=window.indexedDB.open(i.IDB_DATABASE_NAME,i.IDB_VERSION);e.onerror=function(e){console.log("An error occured when trying to open indexedDB",e.target.errorCode)},e.onsuccess=function(e){t=e.target.result,n(t)},e.onupgradeneeded=function(e){e.currentTarget.result.createObjectStore(i.IDB_RESTAURANT_STORE_NAME,{keyPath:"id"})}}},{key:"fetchRestaurants",value:function(n){fetch(i.DATABASE_URL).then(function(e){return e.json()}).then(function(e){return n(null,e)}).catch(function(e){console.log("Request failed. Returned status of  "+e)})}},{key:"fetchRestaurantById",value:function(r,a){i.fetchRestaurants(function(e,n){if(e)a(e,null);else{var t=n.find(function(e){return e.id==r});t?a(null,t):a("Restaurant does not exist",null)}})}},{key:"fetchRestaurantByCuisine",value:function(r,a){i.fetchRestaurants(function(e,n){if(e)a(e,null);else{var t=n.filter(function(e){return e.cuisine_type==r});a(null,t)}})}},{key:"fetchRestaurantByNeighborhood",value:function(r,a){i.fetchRestaurants(function(e,n){if(e)a(e,null);else{var t=n.filter(function(e){return e.neighborhood==r});a(null,t)}})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,a,o){i.fetchRestaurants(function(e,n){if(e)o(e,null);else{var t=n;"all"!=r&&(t=t.filter(function(e){return e.cuisine_type==r})),"all"!=a&&(t=t.filter(function(e){return e.neighborhood==a})),o(null,t)}})}},{key:"fetchNeighborhoods",value:function(a){i.fetchRestaurants(function(e,t){if(e)a(e,null);else{var r=t.map(function(e,n){return t[n].neighborhood}),n=r.filter(function(e,n){return r.indexOf(e)==n});a(null,n)}})}},{key:"fetchCuisines",value:function(a){i.fetchRestaurants(function(e,t){if(e)a(e,null);else{var r=t.map(function(e,n){return t[n].cuisine_type}),n=r.filter(function(e,n){return r.indexOf(e)==n});a(null,n)}})}},{key:"fetchReviews",value:function(n){fetch(i.REVIEWS_URL).then(function(e){return e.json()}).then(function(e){return n(null,e)}).catch(function(e){console.log("Request for reviews failed. Returned status of  "+e)})}},{key:"reviewsById",value:function(r){i.fetchReviews(function(e,n){if(e)r(e,null);else{var t=n.filter(function(e){return e.restaurant_id===self.restaurant.id});r(null,t)}})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return"/img/"+e.photograph+".webp"}},{key:"mapMarkerForRestaurant",value:function(e,n){var t=new L.marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name,url:i.urlForRestaurant(e)});return t.addTo(newMap),t}},{key:"addToFavLocal",value:function(r){i.openIndexedDB(function(e){var t=e.transaction("restaurants","readwrite").objectStore("restaurants");t.get(r.id).onsuccess=function(e){var n=e.target.result;n=Object.assign({},n,r),t.put(n),console.log("addToFavLocal -> success")}})}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337/restaurants"}},{key:"REVIEWS_URL",get:function(){return"http://localhost:1337/reviews"}},{key:"IDB_DATABASE_NAME",get:function(){return"restaurants-db"}},{key:"IDB_VERSION",get:function(){return 1}},{key:"IDB_RESTAURANT_STORE_NAME",get:function(){return"restaurants"}}]),i}(),restaurant=void 0;document.addEventListener("DOMContentLoaded",function(e){initMap()});var initMap=function(){fetchRestaurantFromURL(function(e,n){e?console.error(e):(self.newMap=L.map("map",{center:[n.latlng.lat,n.latlng.lng],zoom:16,scrollWheelZoom:!1}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token={mapboxToken}",{mapboxToken:"pk.eyJ1IjoiaXVsaXVzOTAiLCJhIjoiY2pqb3Fma29rMTFoNjNyb25jMDRiYnAxNSJ9.PMA0jzhYpM4MJnmkzDxxlg",maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(newMap),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.newMap))})},fetchRestaurantFromURL=function(t){if(self.restaurant)t(null,self.restaurant);else{var e=getParameterByName("id");e?DBHelper.fetchRestaurantById(e,function(e,n){(self.restaurant=n)?(fillRestaurantHTML(),t(null,n)):console.error(e)}):(error="No restaurant id in URL",t(error,null))}},fillRestaurantHTML=function(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant;document.getElementById("restaurant-name").innerHTML=r.name,document.getElementById("restaurant-address").innerHTML=r.address;var e=document.getElementById("restaurant-img");e.className="restaurant-img",e.src=r.photograph?DBHelper.imageUrlForRestaurant(r):"img/image_not_found.png",e.alt=r.name,document.getElementById("restaurant-cuisine").innerHTML=r.cuisine_type;var n=document.querySelector(".restaurant-header button");r.is_favorite&&n.classList.add("is-favorite"),n.addEventListener("click",function(){n.classList.toggle("is-favorite");var e=!!n.classList.contains("is-favorite");r.is_favorite=e,r.updatedAt=Number(new Date);var t={id:r.id,is_favorite:r.is_favorite,updatedAt:r.updatedAt};DBHelper.addToFavLocal(t),function n(){return fetch("http://localhost:1337/restaurants/"+r.id+"/?",{method:"PUT",body:JSON.stringify(t),headers:{"content-type":"application/json"}}).then(function(e){console.log("addToFavServer -> success",e),navigator.onLine&&window.removeEventListener("online",n)}).catch(function(e){console.log("addToFavServer -> ERROR",e),window.addEventListener("online",n)})}()}),r.operating_hours&&fillRestaurantHoursHTML(),fillReviewsHTML()},fillRestaurantHoursHTML=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant.operating_hours,n=document.getElementById("restaurant-hours");for(var t in e){var r=document.createElement("tr"),a=document.createElement("td");a.innerHTML=t,r.appendChild(a);var o=document.createElement("td");o.innerHTML=e[t],r.appendChild(o),n.appendChild(r)}},fillReviewsHTML=function(){var i=void 0;DBHelper.reviewsById(function(e,n){if(e)console.log("something went wrong when fetching reviews by id");else{i=n;var t=document.getElementById("reviews-container"),r=document.createElement("h2");if(r.innerHTML="Reviews",t.appendChild(r),!i){var a=document.createElement("p");return a.innerHTML="No reviews yet!",void t.appendChild(a)}var o=document.getElementById("reviews-list");i.forEach(function(e){o.appendChild(createReviewHTML(e))}),t.appendChild(o)}})},createReviewHTML=function(e){var n=document.createElement("li"),t=document.createElement("p");t.innerHTML=e.name,n.appendChild(t);var r=document.createElement("p");r.innerHTML=new Date(e.updatedAt).toDateString(),n.appendChild(r);var a=document.createElement("p");a.innerHTML="Rating: "+e.rating,n.appendChild(a);var o=document.createElement("p");return o.innerHTML=e.comments,n.appendChild(o),n},fillBreadcrumb=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant,n=document.getElementById("breadcrumb"),t=document.createElement("li");t.innerHTML=e.name,n.appendChild(t)},getParameterByName=function(e,n){n||(n=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var t=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(n);return t?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null};